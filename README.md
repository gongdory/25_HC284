# 25_HC284
ì¸ê°„ì˜ ì›€ì§ì„ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¸ì‹í•˜ë©° ë¡œë´‡íŒ”ê³¼ ì£¼í–‰ í”Œë«í¼ì„ ë™ì‹œì— ì œì–´í•˜ëŠ” ì¬ë‚œ êµ¬ì¡°ìš© í˜‘ì—… ë¡œë´‡ ì‹œìŠ¤í…œ

# ğŸ¤– [25_HC284] ì¸ê°„-ë¡œë´‡ í˜‘ì—…í˜• ì›¨ì–´ëŸ¬ë¸” ì¬ë‚œ êµ¬ì¡° ë©”ì¹´ë‹‰

---

## ğŸ’¡ 1. í”„ë¡œì íŠ¸ ê°œìš”

### 1-1. í”„ë¡œì íŠ¸ ì†Œê°œ
- **í”„ë¡œì íŠ¸ ëª…:** ì¸ê°„â€“ë¡œë´‡ í˜‘ì—…í˜• ì¬ë‚œ êµ¬ì¡° ë©”ì¹´ë‹‰  
- **í”„ë¡œì íŠ¸ ì •ì˜:**  
  ì¸ê°„ì˜ ì›€ì§ì„ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¸ì‹í•˜ê³  ì´ë¥¼ ë¡œë´‡ì˜ ì†Â·íŒ”Â·ì£¼í–‰ë¶€ì— ì •ë°€í•˜ê²Œ ë°˜ì˜í•¨ìœ¼ë¡œì¨  
  ì‚¬ëŒê³¼ ë¡œë´‡ì´ ë™ì‹œì— í˜‘ë ¥í•  ìˆ˜ ìˆëŠ” ì¬ë‚œ ëŒ€ì‘í˜• í˜‘ë™ ë¡œë´‡ ì‹œìŠ¤í…œ

---

### 1-2. ê°œë°œ ë°°ê²½ ë° í•„ìš”ì„±
ìµœê·¼ 10ë…„ê°„, ì „ ì„¸ê³„ëŠ” ê¸°í›„ ìœ„ê¸°Â·ì´ˆê³ ì¸µí™”Â·ì¸í”„ë¼ ë…¸í›„í™”ë¡œ ì¸í•´ ë³µí•© ì¬ë‚œì´ ê¸‰ì¦í•˜ê³  ìˆìŠµë‹ˆë‹¤.  
ì´ëŸ¬í•œ í™˜ê²½ì—ì„œ ì¸ê°„ì´ ì§ì ‘ ì ‘ê·¼í•˜ê¸° ì–´ë ¤ìš´ ì¬ë‚œ í˜„ì¥(ë¶•ê´´, í™”ì¬, ìœ ë…ê°€ìŠ¤ ë“±)ì—ì„œëŠ”  
ê¸°ì¡´ì˜ ì¸ë ¥ ì¤‘ì‹¬ êµ¬ì¡° ë°©ì‹ì´ ì ‘ê·¼ì„±Â·ì•ˆì „ì„±Â·ì§€ì†ì„± ì¸¡ë©´ì—ì„œ í•œê³„ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.  

ì´ì— ë”°ë¼ ë¡œë´‡ì˜ ë¬¼ë¦¬ì  ë‚´êµ¬ì„±ê³¼ ì •ë°€ ì œì–´ ëŠ¥ë ¥,  
ì¸ê°„ì˜ ìƒí™© íŒë‹¨ë ¥ê³¼ ìœ ì—°í•œ ì˜ì‚¬ ê²°ì • ëŠ¥ë ¥ì„ ê²°í•©í•œ  
â€˜ì¸ê°„â€“ë¡œë´‡ í˜‘ì—…í˜• êµ¬ì¡° ë©”ì¹´ë‹‰â€™ì˜ í•„ìš”ì„±ì´ ëŒ€ë‘ë˜ì—ˆìŠµë‹ˆë‹¤.  

ì´ ì‹œìŠ¤í…œì€ ë‹¨ìˆœ ì›ê²© ì¡°ì‘í˜• ë¡œë´‡ì„ ë„˜ì–´,  
**ì°©ìš©í˜•Â·ììœ¨í˜•Â·í˜‘ì—…í˜• êµ¬ì¡° í”Œë«í¼**ìœ¼ë¡œ ì§„í™”í•¨ìœ¼ë¡œì¨  
ì¬ë‚œ ëŒ€ì‘ì˜ íš¨ìœ¨ì„±ê³¼ ìƒì¡´ìœ¨ì„ ê·¹ëŒ€í™”í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.

---

### 1-3. í”„ë¡œì íŠ¸ íŠ¹ì¥ì 
- **ì •ë°€ ì œì–´ ê¸°ë°˜ êµ¬ë™ ì‹œìŠ¤í…œ:**  
  19ììœ ë„ ë¡œë´‡ ì†ê³¼ 6ì¶• ë¡œë´‡ íŒ”ì— ê³ í•´ìƒë„ ì—”ì½”ë” ë° PIDÂ·ì„í”¼ë˜ìŠ¤ ì œì–´ë¥¼ ì ìš©í•˜ì—¬,  
  ë¯¸ì„¸í•œ ì›€ì§ì„ê³¼ ì™¸ë ¥ì—ë„ ì•ˆì •ì ìœ¼ë¡œ ë°˜ì‘í•˜ëŠ” ì •ë°€ ì œì–´ êµ¬í˜„  
- **ì›¨ì–´ëŸ¬ë¸” ì—°ë™ í˜‘ë™ ì œì–´:**  
  IMUÂ·EMGÂ·í¬ì§€ì…˜ ì„¼ì„œë¥¼ íƒ‘ì¬í•œ ê¸€ëŸ¬ë¸Œë¥¼ í†µí•´ ì‚¬ìš©ìì˜ ì†Â·íŒ” ë™ì‘ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¡œë´‡ì— ë§¤í•‘  
- **ììœ¨ ì£¼í–‰í˜• ëª¨ë¹Œë¦¬í‹° í”Œë«í¼:**  
  2D LiDARÂ·IMUÂ·Depth ì¹´ë©”ë¼ ê¸°ë°˜ SLAM ê¸°ìˆ ì„ ì ìš©í•´ ììœ¨ ì´ë™ ë° ì¥ì• ë¬¼ íšŒí”¼ ê°€ëŠ¥  
- **ROS ê¸°ë°˜ í†µí•© ì œì–´ í”„ë ˆì„ì›Œí¬:**  
  ì†Â·íŒ”Â·ì£¼í–‰ë¶€ì˜ ë™ì‘ì„ ROS í™˜ê²½ì—ì„œ í†µí•© ë™ê¸°í™”í•˜ì—¬ ì‹œë®¬ë ˆì´ì…˜Â·ê¶¤ì  ê³„íšÂ·ì¶©ëŒ íšŒí”¼ ìˆ˜í–‰ ê°€ëŠ¥  

---

### 1-4. ì£¼ìš” ê¸°ëŠ¥
- **ì›¨ì–´ëŸ¬ë¸” ì…ë ¥ ì¥ì¹˜:** IMU, í¬ì§€ì…˜, EMG ì„¼ì„œ ê¸°ë°˜ ë™ì‘ ì¸ì‹ ë° ë°ì´í„° ì „ì†¡  
- **ë¡œë´‡ ì†(19 DoF):** ì„œë³´ëª¨í„° ì§ì ‘ êµ¬ë™, ì—”ì½”ë” í”¼ë“œë°± ê¸°ë°˜ ì •ë°€ íŒŒì§€ ì œì–´  
- **ë¡œë´‡ íŒ”(6 DoF):** ì—­ê¸°êµ¬í•™ ê¸°ë°˜ ìì„¸ ê³„ì‚° ë° íë£¨í”„ ê¶¤ì  ì œì–´  
- **ììœ¨ ì£¼í–‰ í”Œë«í¼:** LiDAR + SLAM ê¸°ë°˜ í™˜ê²½ ì¸ì‹ ë° ë™ì  ì´ë™  
- **í†µí•© ì œì–´ ì‹œìŠ¤í…œ:** ROS ê¸°ë°˜ ì‹¤ì‹œê°„ ë™ê¸°í™” ë° ëª¨ë“ˆ ê°„ í˜‘ì¡° ì œì–´ êµ¬ì¡°  

---

### 1-5. ê¸°ëŒ€ íš¨ê³¼ ë° í™œìš© ë¶„ì•¼
- **ê¸°ëŒ€ íš¨ê³¼:**  
  ì •ë°€ ì œì–´Â·ììœ¨ ì£¼í–‰Â·ì‹¤ì‹œê°„ í˜‘ë™ ì œì–´ë¥¼ í†µí•©í•˜ì—¬ ì¸ê°„ê³¼ ë¡œë´‡ì´ í•¨ê»˜ ì›€ì§ì´ëŠ”  
  ì§€ëŠ¥í˜• í˜‘ì—… í”Œë«í¼ êµ¬í˜„ â†’ ì¬ë‚œ ëŒ€ì‘ ë¡œë´‡ì˜ ì •ë°€ì„±Â·ì•ˆì •ì„±Â·í™•ì¥ì„± í–¥ìƒ  
- **í™œìš© ë¶„ì•¼:**  
  ì¬ë‚œ êµ¬ì¡° / ì‚°ì—… ìë™í™” / ì˜ë£ŒÂ·ì¬í™œ / êµìœ¡Â·ì—°êµ¬ / êµ­ë°©Â·íƒì‚¬ ë“±  

---

### 1-6. ê¸°ìˆ  ìŠ¤íƒ
| êµ¬ë¶„ | ì‚¬ìš© ê¸°ìˆ  |
|------|-------------|
| **í†µì‹ ** | CAN, UART, TCP/IP |
| **ëª¨í„°ì œì–´** | PID, ì „ë¥˜ ê¸°ë°˜ ìœ„ì¹˜ ì œì–´ |
| **MCU ì œì–´** | Timer, Interrupt |
| **Vision** | YOLOv11, OpenCV, RealSense SDK |
| **ROS** | URDF, Gazebo |
| **ë¡œë´‡íŒ” ì œì–´** | FK, IK, KDL |
| **ì„¼ì„œ ë°ì´í„°** | ì¹¼ë§Œ í•„í„°, ì €ì—­ í†µê³¼ í•„í„° |
| **ë°°í¬ ë° ê´€ë¦¬** | GitHub, STM32CubeIDE, ROS |

---

## ğŸ‘¥ 2. íŒ€ì› ì†Œê°œ


<table>
  <tr>
    <td align="center" width="200" height="230" valign="top">
      <img src="https://github.com/user-attachments/assets/16435f88-e7d3-4e45-a128-3d32648d2d84" width="180" style="border-radius:10px; margin-bottom:10px;"><br>
      <b>ì•ˆì •ì€</b><br>
      íŒ€ì¥<br>
      â€¢ ì† ì„¼ì„œë¶€&êµ¬ë™ë¶€<br>ì„¤ê³„ ë³´ì¡°<br>â€¢ í”„ë¡œì íŠ¸ ê´€ë¦¬
    </td>
    <td align="center" width="200" height="230" valign="top">
      <img src="https://github.com/user-attachments/assets/16435f88-e7d3-4e45-a128-3d32648d2d84" width="180" style="border-radius:10px; margin-bottom:10px;"><br>
      <b>ìµœë¯¼ê¶Œ</b><br>
      ë©˜í‹°<br>
      â€¢ ì„¼ì„œë¶€Â·êµ¬ë™ë¶€ ê¸°íš <br>â€¢ ì„¤ê³„ ì´ê´„ <br>â€¢ ì‹œìŠ¤í…œ ì œì–´&ê¸°ëŠ¥ êµ¬í˜„
    </td>
    <td align="center" width="200" height="230" valign="top">
      <img src="https://github.com/user-attachments/assets/16435f88-e7d3-4e45-a128-3d32648d2d84" width="180" style="border-radius:10px; margin-bottom:10px;"><br>
      <b>ì¥í˜•ì¤€</b><br>
      ë©˜í‹°<br>
      â€¢ êµ¬ë™ë¶€ ì„¤ê³„  <br>â€¢ ì„œë¥˜ ì‘ì—… ë³´ì¡° <br>â€¢ ëª¨ë°”ì¼ ê¸°íš ë³´ì¡°
    </td>
    <td align="center" width="200" height="230" valign="top">
      <img src="https://github.com/user-attachments/assets/16435f88-e7d3-4e45-a128-3d32648d2d84" width="180" style="border-radius:10px; margin-bottom:10px;"><br>
      <b>ê¹€ì„œí¬</b><br>
      ë©˜í‹°<br>
      â€¢ êµ¬ë™ë¶€ ì„¤ê³„ ë³´ì¡°  <br>â€¢ íšŒë¡œ êµ¬ì„± ë³´ì¡° <br>â€¢ ì œì‘
    </td>
    <td align="center" width="200" height="230" valign="top">
      <img src="https://github.com/user-attachments/assets/16435f88-e7d3-4e45-a128-3d32648d2d84" width="180" style="border-radius:10px; margin-bottom:10px;"><br>
      <b>ê¹€ë™ì˜</b><br>
      ë©˜í† <br>
      â€¢ í”„ë¡œì íŠ¸ ë©˜í†  <br>â€¢ ê¸°ìˆ  ìë¬¸ <br>â€¢ í”„ë¡œì íŠ¸ ê´€ë¦¬
    </td>
  </tr>
</table>



---

## âš™ï¸ 3. ì‹œìŠ¤í…œ êµ¬ì„±ë„
- **ì„œë¹„ìŠ¤ êµ¬ì„±ë„**  
  (ì‹œìŠ¤í…œ ë¸”ë¡ë„, ë°ì´í„° íë¦„ë„, ì œì–´ êµ¬ì¡°ë„ ë“± ì²¨ë¶€ ì˜ˆì •)]
  
<img width="1685" height="956" alt="image" src="https://github.com/user-attachments/assets/b0f8f22a-bd32-4aca-95cd-5951eeefd84f" />

- **ì—”í‹°í‹° ê´€ê³„ë„(ERD)**  
  (DB ì„¤ê³„ ë‹¤ì´ì–´ê·¸ë¨ ì²¨ë¶€)

---

## ğŸ¬ 4. ì‘í’ˆ ì†Œê°œì˜ìƒ
ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•˜ë©´, ì¸ë„¤ì¼ê³¼ ìœ íŠœë¸Œ ì˜ìƒ ë§í¬ë¥¼ í•¨ê»˜ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ì˜ˆì‹œ:  
[![í”„ë¡œì íŠ¸ ì†Œê°œ](https://www.youtube.com/watch?v=w8o6nSqm-DI)

---

## ğŸ’» 5. í•µì‹¬ ì†ŒìŠ¤ì½”ë“œ
#!/usr/bin/env python3
import rospy
from sensor_msgs.msg import JointState
from geometry_msgs.msg import PoseStamped
import PyKDL as kdl
from urdf_parser_py.urdf import URDF
import kdl_parser_py.urdf
from trajectory_msgs.msg import JointTrajectory, JointTrajectoryPoint
import time
from std_msgs.msg import Bool

class KDL_IK_Solver:
    def __init__(self):
        rospy.init_node("kdl_ik_solver", anonymous=True)
        self.cmd_pub = rospy.Publisher(
            "/arm_controller/command", JointTrajectory, queue_size=10
        )

        base_link = rospy.get_param("~base_link", "base_link")
        tip_link  = rospy.get_param("~tip_link", "palm_1")
        self.max_speed = rospy.get_param("~max_speed", 1.5)

        # rospy.loginfo("Loading URDF from parameter server...")
        robot = URDF.from_parameter_server()

        success, self.kdl_tree = kdl_parser_py.urdf.treeFromUrdfModel(robot)
        if not success:
            # rospy.logerr("Failed to parse URDF into KDL tree.")
            return

        self.chain = self.kdl_tree.getChain(base_link, tip_link)
        # rospy.loginfo_once(
        #     f"Created KDL chain from [{base_link}] to [{tip_link}] "
        #     f"with {self.chain.getNrOfJoints()} joints."
        # )

        self.fk_solver = kdl.ChainFkSolverPos_recursive(self.chain)
        self.ik_solver = kdl.ChainIkSolverPos_LMA(self.chain)

        self.joint_names = []
        for i in range(self.chain.getNrOfSegments()):
            joint = self.chain.getSegment(i).getJoint()
            jtype = str(joint.getType())
            if "None" not in jtype:
                self.joint_names.append(joint.getName())
                
        self.joint_names.pop()
        # rospy.loginfo(f"Using joints: {self.joint_names}")

        self.q_current = kdl.JntArray(len(self.joint_names))
        
        self.switch_on = False

        rospy.Subscriber("/joint_states", JointState, self.joint_state_callback)
        rospy.Subscriber("/fusion_pose", PoseStamped, self.fusion_pose_callback)
        rospy.Subscriber("/switch", Bool, self.switch_callback)

        # rospy.loginfo("KDL IK Solver node initialized.")
        rospy.spin()
        
        
    def switch_callback(self, msg):
        self.switch_on = msg.data  
        rospy.loginfo_throttle(1.0, f"switch status {self.switch_on}")


    def joint_state_callback(self, msg):
        for i, name in enumerate(self.joint_names):
            if name in msg.name:
                idx = msg.name.index(name)
                self.q_current[i] = msg.position[idx]

    def fusion_pose_callback(self, msg):
        if not self.switch_on:
            rospy.loginfo_throttle(1.0, "switch off")
            return
        
        # start = time.time()
        
        if all(abs(self.q_current[i]) < 1e-6 for i in range(self.q_current.rows())):
            rospy.logwarn_throttle(1.0, "No valid joint_states yet â€” skipping IK.")
            return

        pos = msg.pose.position
        ori = msg.pose.orientation

        target_frame = kdl.Frame(
            kdl.Rotation.Quaternion(ori.x, ori.y, ori.z, ori.w),
            kdl.Vector(pos.x, pos.y, pos.z)
        )

        q_sol = kdl.JntArray(len(self.joint_names))
        ret = self.ik_solver.CartToJnt(self.q_current, target_frame, q_sol)
        
        deltas = [abs(float(q_sol[i] - self.q_current[i])) for i in range(q_sol.rows())]
        max_delta = max(deltas) if deltas else 0.0
        speed = max(self.max_speed, 1e-6)
        duration = max_delta / speed

        duration = max(duration, 0.1)

        if ret >= 0:
            joint_values = [round(q_sol[i], 4) for i in range(q_sol.rows())]
            # rospy.loginfo_throttle(1.0, f" IK Solved: {joint_values}")
            
            traj = JointTrajectory()
            traj.joint_names = self.joint_names
            point = JointTrajectoryPoint()
            point.positions = joint_values
            point.time_from_start = rospy.Duration(duration)
            traj.points.append(point)
            self.cmd_pub.publish(traj)
            # end = time.time()
            # print(f"ì—°ì‚° ì‹œê°„time : {end-start}")
        else:
            rospy.logwarn_throttle(1.0, "IK failed")

if __name__ == "__main__":
    KDL_IK_Solver()

